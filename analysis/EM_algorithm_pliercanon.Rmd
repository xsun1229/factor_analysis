---
title: "EM_algorithm_pliercanon"
author: "XSun"
date: "2020-12-14"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

We will try to [relate the PLIER-Canonical factors to GWAS of complex traits](https://www.overleaf.com/project/5fc6d070dbe8f5b9fe43a54b).

## Methods

1. EM algorithm settings.

The detailed equations are in the [overleaf file](https://www.overleaf.com/project/5fc6d070dbe8f5b9fe43a54b). 

For all trait-LV pairs with >= 2 SNPs passing FDR<0.2 cutoff. I use the EM algorithm to infer the gamma and pi.

We need to set initial values for gamma, pi and sigma2. For gamma, I use the slope in the effect size correlation plot at FDR < 0.2. For pi, I used  (number of SNP have FDR<0.2)/(number of data points in GWAS). For sigma2, I fitted a normal distribution with mean 0 to all GWAS effect sizes and used the sd2 as the sigma2.


Below are the codes I used.

```{r eval=FALSE, echo=T}
EM <- function(dat) {
  
        gamma <- c()
        pi_bern <- c()
        
        gamma[1] <- beta_fit
        pi_bern[1] <- nrow(snp_select)/nrow(dat)
        
        t <- 0
        while (length(gamma) == 1 ||  abs( gamma[length(gamma)] - gamma[length(gamma)-1]) >1e-5) {
          
          t <- t+1
          
          p <- pi_bern[t]*dnorm(dat$beta.outcome,mean = gamma[t]*dat$beta.exposure,sd = (dat$se.outcome))/((1-pi_bern[t])* dnorm(dat$beta.outcome,mean = 0,sd = sqrt(sigma^2 + (dat$se.outcome)^2)) + pi_bern[t]*dnorm(dat$beta.outcome,mean = gamma[t]*dat$beta.exposure,sd = (dat$se.outcome)))
          
          pi_bern[t+1] <- sum(p)/nrow(dat)
          
          gamma[t+1] <- sum(dat$beta.outcome * p * dat$beta.exposure/(dat$se.outcome)^2) / sum(((dat$beta.exposure)^2 *p)/(dat$se.outcome)^2)
          
        }
        
        results <- list(p,pi_bern,gamma)
        names(results) <- c("p","pi","gamma")
        return(results)
        
      }
      
      EM_results <- try(EM(dat = dat))

```

2. Likelihood ratio test

We used LRT to test if there is a causal effect. The H0 here: pi = 0 and the H1: pi is free. I compute LRT statistic as follows: 

```{r eval=FALSE, echo=T}
      log_lik_0 <- sum(log(dnorm(dat$beta.outcome,mean = 0, sd = sqrt(sigma^2 + dat$se.outcome^2) )))
      
      gamma_f <- EM_results$gamma[length(EM_results$gamma)]
      pi_f <- EM_results$pi[length(EM_results$pi)]
      log_lik_1 <- sum(log((1-pi_f)*dnorm(dat$beta.outcome,mean = 0, sd = sqrt(sigma^2 + dat$se.outcome^2)) + pi_f *dnorm(dat$beta.outcome,mean = gamma_f*dat$beta.exposure,sd = dat$se.outcome)))
      
      LRT <- 2*log(log_lik_1/log_lik_0)  ####LRT statistic
      
      pval <- pchisq(LRT,df = 2, lower.tail = F)   ####LRT statistic follows chi-squared distribution with freedom = 2.

```

3. Resampling

The test may not be robust to misspeification of the prior. So I resampled the beta_j from the data set to calculate the gamma_initial to initialize the EM and compute the new LRT statistic accordingly. 

The resampling was repeated 1000 times. 

The 'p-value from resampling' is computed by: (number of more extreme values)/(times of resampling).

4. effectsize plots 

I made scattor plots to show all the effectsize data point for each trait-LV pairs. The points are colored by the p_j in EM results according to the following rules:

p_j > 0.1  "orange"  marked as "1"

0.01< p_j < 0.1  "red"  marked as "2"

0.001< p_j < 0.01  "green"  marked as "3" 

others  "blue"  marked as "4" 


## Results 

### EM algorithm summary table 

I made a table to show the pi and gamma in EM iteration. 

```{r echo=FALSE}
load("/project2/xinhe/xsun/website/factor_analysis/output/EM_SUM.rdata")
DT::datatable(summary, options = list(pageLength =20))
```

### Diagnosis plots 

For the pairs have pvalue < 0.05 in resampling (fdr<0.2 cutoff), I made effectsize plots for all data points. The points are colored by the p_j in EM results according to the following rules:

p_j > 0.1  "orange"  marked as "1"

0.01< p_j < 0.1  "red"  marked as "2"

0.001< p_j < 0.01  "green"  marked as "3" 

others  "blue"  marked as "4" 

For those points have relatively high p_j(greater than 0.01), I made effectsize plots to show if they are correlated.


#### LDL

LV125

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv125_LDL_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv125_LDL_emp_top.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv125_LDL_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_125_LDL.jpeg" width="30%">
</figure>


#### lymphocyte count(lymph)

LV26

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv26_lymph_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv26_lymph_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_26_lymph.jpeg" width="30%">
</figure>




#### plt

LV49

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv49_plt_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv49_plt_emp_top.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv49_plt_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_49_plt.jpeg" width="30%">
</figure>



#### rbc

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv82_rbc_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv82_rbc_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_82_rbc.jpeg" width="30%">
</figure>


#### asthma

LV36

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv36_ukb.allasthma_emp.jpeg" width="30%">
</figure>


<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv36_ukb.allasthma_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_36_ukb.allasthma.jpeg" width="30%">
</figure>


LV39

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv39_ukb.allasthma_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv39_ukb.allasthma_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_39_ukb.allasthma.jpeg" width="30%">
</figure>




#### wbc

LV6

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv6_wbc_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv6_wbc_emp_top.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv6_wbc_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_6_wbc.jpeg" width="30%">
</figure>

LV119

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv119_wbc_emp.jpeg" width="30%">
</figure>

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv119_wbc_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_119_wbc.jpeg" width="30%">
</figure>


#### WHR

LV47

<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv47_WHR_emp.jpeg" width="30%">
</figure>


<figure class="half">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/effectsize_lv47_WHR_pval5e8_d1k_ageco.jpeg" width="30%">
    <img src="https://github.com/xsun1229/factor_analysis/raw/master/output/resampling_hist_pliercanon_47_WHR.jpeg" width="30%">
</figure>

